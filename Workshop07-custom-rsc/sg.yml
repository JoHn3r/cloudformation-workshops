---
AWSTemplateFormatVersion: 2010-09-09
Description: A Security Group
Parameters:
  Env:
    Type: String
  IngressCidrList:
    Type: List<String>
    Default: "10.0.0.0/8,null,null"
Conditions:
  Cidr1Exists: !Not [ !Equals [!Select [0, !Ref 'IngressCidrList'], 'null']]
  Cidr2Exists: !Not [ !Equals [!Select [1, !Ref 'IngressCidrList'], 'null']]
  Cidr3Exists: !Not [ !Equals [!Select [2, !Ref 'IngressCidrList'], 'null']]
Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${Env}-custom-rsc-test-sg'
      GroupDescription: Security Group to test custom resources
      VpcId:
        Fn::ImportValue: !Sub '${Env}-vpc-id'
      SecurityGroupIngress:
        - Fn::If:
            - 'Cidr1Exists'
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: !Select [0, !Ref 'IngressCidrList']
            - !Ref 'AWS::NoValue'
        - Fn::If:
            - 'Cidr2Exists'
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: !Select [1, !Ref 'IngressCidrList']
            - !Ref 'AWS::NoValue'
        - Fn::If:
            - 'Cidr3Exists'
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: !Select [2, !Ref 'IngressCidrList']
            - !Ref 'AWS::NoValue'
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Env}-custom-rsc-test-sg'
